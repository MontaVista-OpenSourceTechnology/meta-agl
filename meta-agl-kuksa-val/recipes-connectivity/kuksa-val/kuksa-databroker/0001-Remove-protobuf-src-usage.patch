From e53c582959210b0047f3b27eadf29d07d8b2bcf0 Mon Sep 17 00:00:00 2001
From: Scott Murray <scott.murray@konsulko.com>
Date: Wed, 4 Dec 2024 09:53:15 -0500
Subject: [PATCH] Remove protobuf-src usage

The vendoring of a protoc and libprotobuf build that was added in
commit 890703c9 by using protobuf-src is not really workable with
OpenEmbedded / Yocto Project, and somewhat undesirable for any
distribution package builds when it comes to transparency and
reproducibility.  Remove it so that building in OE/YP will work.

Upstream-Status: Pending

Signed-off-by: Scott Murray <scott.murray@konsulko.com>
---
 Cargo.lock                  | 19 -------------------
 databroker-proto/Cargo.toml |  1 -
 databroker-proto/build.rs   |  1 -
 lib/Cargo.lock              | 19 -------------------
 4 files changed, 40 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index 1ea94f9..1f3ff09 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -175,15 +175,6 @@ version = "1.5.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "c08606f8c3cbf4ce6ec8e28fb0014a2c086708fe954eaa885384a6165172e7e8"
 
-[[package]]
-name = "autotools"
-version = "0.2.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ef941527c41b0fc0dd48511a8154cd5fc7e29200a0ff8b7203c5d777dbc795cf"
-dependencies = [
- "cc",
-]
-
 [[package]]
 name = "axum"
 version = "0.6.20"
@@ -688,7 +679,6 @@ version = "0.6.0"
 dependencies = [
  "prost 0.12.6",
  "prost-types",
- "protobuf-src",
  "tonic 0.11.0",
  "tonic-build",
 ]
@@ -2724,15 +2714,6 @@ dependencies = [
  "prost 0.12.6",
 ]
 
-[[package]]
-name = "protobuf-src"
-version = "1.1.0+21.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c7ac8852baeb3cc6fb83b93646fb93c0ffe5d14bf138c945ceb4b9948ee0e3c1"
-dependencies = [
- "autotools",
-]
-
 [[package]]
 name = "quote"
 version = "1.0.40"
diff --git a/databroker-proto/Cargo.toml b/databroker-proto/Cargo.toml
index 3585a90..49bcaae 100644
--- a/databroker-proto/Cargo.toml
+++ b/databroker-proto/Cargo.toml
@@ -25,4 +25,3 @@ prost-types = { workspace = true }
 
 [build-dependencies]
 tonic-build = { workspace = true, features = ["transport", "prost"] }
-protobuf-src = "1.1.0"
diff --git a/databroker-proto/build.rs b/databroker-proto/build.rs
index 4eec3f1..edb1c81 100644
--- a/databroker-proto/build.rs
+++ b/databroker-proto/build.rs
@@ -14,7 +14,6 @@
 use std::{env, path::PathBuf};
 
 fn main() -> Result<(), Box<dyn std::error::Error>> {
-    std::env::set_var("PROTOC", protobuf_src::protoc());
     tonic_build::configure()
         .compile_well_known_types(false)
         .protoc_arg("--experimental_allow_proto3_optional")
diff --git a/lib/Cargo.lock b/lib/Cargo.lock
index 9a1ab95..183ed6d 100644
--- a/lib/Cargo.lock
+++ b/lib/Cargo.lock
@@ -121,15 +121,6 @@ version = "1.5.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "c08606f8c3cbf4ce6ec8e28fb0014a2c086708fe954eaa885384a6165172e7e8"
 
-[[package]]
-name = "autotools"
-version = "0.2.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ef941527c41b0fc0dd48511a8154cd5fc7e29200a0ff8b7203c5d777dbc795cf"
-dependencies = [
- "cc",
-]
-
 [[package]]
 name = "axum"
 version = "0.6.20"
@@ -257,7 +248,6 @@ version = "0.6.0"
 dependencies = [
  "prost 0.12.6",
  "prost-types",
- "protobuf-src",
  "tonic",
  "tonic-build",
 ]
@@ -928,15 +918,6 @@ dependencies = [
  "prost 0.12.6",
 ]
 
-[[package]]
-name = "protobuf-src"
-version = "1.1.0+21.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c7ac8852baeb3cc6fb83b93646fb93c0ffe5d14bf138c945ceb4b9948ee0e3c1"
-dependencies = [
- "autotools",
-]
-
 [[package]]
 name = "quote"
 version = "1.0.40"
-- 
2.51.0

